<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Total Compensation Calculator</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card h2 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    input:focus {
      outline: none;
      border-color: #2557a7;
    }

    .row {
      display: flex;
      gap: 16px;
    }

    .row .form-group {
      flex: 1;
    }

    .refreshers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .refresher-input {
      display: flex;
      flex-direction: column;
    }

    .refresher-input label {
      font-size: 14px;
    }

    button {
      background: #2557a7;
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }

    button:hover {
      background: #1a4380;
    }

    #results {
      display: none;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    th, td {
      padding: 10px 8px;
      text-align: right;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      font-size: 14px;
    }

    th:first-child, td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
    }

    th:first-child {
      background: #f9f9f9;
    }

    th {
      background: #f9f9f9;
      font-weight: 600;
    }

    tr:hover td {
      background: #f5f5f5;
    }

    tr:hover td:first-child {
      background: #f5f5f5;
    }

    .change-positive {
      color: #2e7d32;
    }

    .change-negative {
      color: #c62828;
    }

    .total-row {
      font-weight: bold;
      background: #e8f4e8 !important;
    }

    .total-row td:first-child {
      background: #e8f4e8 !important;
    }

    .toggle-row {
      margin-bottom: 16px;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .toggle-label input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .money {
      font-family: 'SF Mono', Monaco, monospace;
    }

    .stock-price-note {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .reduction-section {
      background: #ffe8e8;
      border-radius: 4px;
      padding: 16px;
      margin-top: 16px;
    }

    .reduction-section h3 {
      margin-top: 0;
      color: #c00;
    }
  </style>
</head>
<body>
  <h1>Total Compensation Calculator</h1>

  <div class="card">
    <h2>Basic Information</h2>
    <div class="row">
      <div class="form-group">
        <label for="joinDate">Join Date</label>
        <input type="date" id="joinDate" required>
      </div>
      <div class="form-group">
        <label for="baseSalary">Base Salary (¥)</label>
        <input type="number" id="baseSalary" placeholder="10000000" required>
      </div>
    </div>
    <div class="row">
      <div class="form-group">
        <label for="bonusPercent">Bonus (%)</label>
        <input type="number" id="bonusPercent" value="10" step="0.1">
      </div>
      <div class="form-group">
        <label for="stockPrice">Stock Price (¥)</label>
        <input type="number" id="stockPrice" placeholder="7500" value="7500" step="1" required>
        <div class="hint">Used to calculate RSU value</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Initial RSU Grant</h2>
    <div class="form-group">
      <label for="initialGrant">Number of Shares</label>
      <input type="number" id="initialGrant" placeholder="10000" required>
      <div class="hint">4-year vest with 1-year cliff. Vests quarterly on Feb 1, May 1, Aug 1, Nov 1.</div>
    </div>
  </div>

  <div class="card">
    <h2>Refresher RSUs</h2>
    <p class="hint">Enter the number of shares granted on each work anniversary. Leave empty or 0 if none.</p>
    <div class="refreshers-grid" id="refreshersGrid">
      <p class="hint" style="grid-column: 1 / -1; background: #fff3cd; padding: 12px; border-radius: 4px;">Enter your join date above to see refresher inputs for each anniversary year.</p>
    </div>

    <div class="reduction-section">
      <h3>Future Refresher Scenario</h3>
      <div class="form-group">
        <label for="reductionPercent">Future refresher as % of average past refreshers</label>
        <input type="number" id="reductionPercent" value="100" min="0" max="200">
        <div class="hint">100% = same as average past refreshers. 40% = 60% reduction from average.</div>
      </div>
      <div id="futureRefresherPreview" class="hint" style="margin-top: 8px;"></div>
    </div>
  </div>

  <div class="card">
    <button onclick="calculate()">Calculate Total Compensation</button>
  </div>

  <div class="card" id="results">
    <h2>Compensation Breakdown</h2>
    <div class="stock-price-note">
      Note: RSU values are calculated using the stock price you provided. Actual value will vary based on stock price at vest date.
    </div>
    <div class="toggle-row">
      <label class="toggle-label">
        <input type="checkbox" id="showJpy" onchange="toggleRsuDisplay()">
        <span>Show RSU values in JPY instead of shares</span>
      </label>
    </div>
    <div id="resultsContent"></div>
  </div>

  <script>
    const VEST_MONTHS = [1, 4, 7, 10]; // Feb=1, May=4, Aug=7, Nov=10 (0-indexed)

    // Historical stock prices for Recruit Holdings (6098.T) on vest dates
    // Source: Yahoo Finance
    const HISTORICAL_STOCK_PRICES = {
      // 2021
      '2021-02-01': 5281,
      '2021-05-01': 5555,
      '2021-08-01': 6500,
      '2021-11-01': 6901,
      // 2022
      '2022-02-01': 4819,
      '2022-05-01': 4734,
      '2022-08-01': 4483,
      '2022-11-01': 4329,
      // 2023
      '2023-02-01': 3704,
      '2023-05-01': 4290,
      '2023-08-01': 5220,
      '2023-11-01': 5505,
      // 2024
      '2024-02-01': 6044,
      '2024-05-01': 7948,
      '2024-08-01': 9047,
      '2024-11-01': 10385,
      // 2025
      '2025-02-01': 8800,
      '2025-05-01': 8689,
      '2025-08-01': 8579,
      '2025-11-01': 8006,
      // 2026
      '2026-02-01': 8344,
    };

    // Helper to get stock price for a date (returns historical if available, otherwise user input)
    function getStockPriceForDate(date, fallbackPrice) {
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-01`;
      return HISTORICAL_STOCK_PRICES[dateStr] || fallbackPrice;
    }

    // Global state for toggling display
    let calculatedData = null;
    let currentStockPrice = 0;

    // Generate refresher inputs on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateRefresherInputs();
      document.getElementById('joinDate').addEventListener('change', updateRefresherInputs);
      document.getElementById('reductionPercent').addEventListener('input', updateFuturePreview);
    });

    function updateRefresherInputs() {
      const joinDateStr = document.getElementById('joinDate').value;
      const grid = document.getElementById('refreshersGrid');

      if (!joinDateStr) {
        grid.innerHTML = '<p class="hint" style="grid-column: 1 / -1; background: #fff3cd; padding: 12px; border-radius: 4px;">Enter your join date above to see refresher inputs for each anniversary year.</p>';
        return;
      }

      const joinDate = new Date(joinDateStr);
      const today = new Date();
      const currentYear = today.getFullYear();

      // Calculate cliff date (first vest of initial grant)
      // Refreshers are granted on cliff date anniversary, not join date anniversary
      const firstAnniversary = new Date(joinDate);
      firstAnniversary.setFullYear(firstAnniversary.getFullYear() + 1);
      const cliffDate = getFirstVestDateOnOrAfter(firstAnniversary);
      const cliffYear = cliffDate.getFullYear();

      let html = '';
      // Year 2 = first refresher, granted on cliff date
      // Year 3 = second refresher, granted on cliff date + 1 year, etc.
      let year = 2;
      let grantYear = cliffYear; // First refresher granted in cliff year

      // Only show inputs for past years (before current year)
      while (grantYear < currentYear) {
        html += `
          <div class="refresher-input">
            <label for="refresher${year}">Year ${year} (${grantYear})</label>
            <input type="number" id="refresher${year}" data-year="${year}"
                   data-grant-year="${grantYear}" placeholder="0" onchange="updateFuturePreview()">
          </div>
        `;
        year++;
        grantYear++;
      }

      grid.innerHTML = html || '<p class="hint" style="grid-column: 1 / -1;">No past refreshers yet (refreshers start from Year 2 on your first vest date).</p>';
      updateFuturePreview();
    }

    function updateFuturePreview() {
      const preview = document.getElementById('futureRefresherPreview');
      const reductionPercent = parseFloat(document.getElementById('reductionPercent').value) || 100;
      const refresherInputs = document.querySelectorAll('#refreshersGrid input');

      let total = 0;
      let count = 0;
      refresherInputs.forEach(input => {
        const val = parseInt(input.value) || 0;
        if (val > 0) {
          total += val;
          count++;
        }
      });

      if (count > 0) {
        const avg = total / count;
        const futureShares = Math.round(avg * reductionPercent / 100);
        preview.innerHTML = `<strong>Average past refresher:</strong> ${Math.round(avg).toLocaleString()} shares → <strong>Future refreshers:</strong> ${futureShares.toLocaleString()} shares/year`;
      } else {
        preview.innerHTML = 'Enter past refresher amounts to see future projections.';
      }
    }

    function getFirstVestDateOnOrAfter(date) {
      // Find the first vest date (Feb 1, May 1, Aug 1, Nov 1) ON OR AFTER the given date
      const vestDates = VEST_MONTHS.map(month => {
        const d = new Date(date.getFullYear(), month, 1);
        if (d < date) {
          d.setFullYear(d.getFullYear() + 1);
        }
        return d;
      });
      vestDates.sort((a, b) => a - b);
      return vestDates[0];
    }

    function getFirstVestDateStrictlyAfter(date) {
      // Find the first vest date (Feb 1, May 1, Aug 1, Nov 1) STRICTLY AFTER the given date
      const vestDates = VEST_MONTHS.map(month => {
        const d = new Date(date.getFullYear(), month, 1);
        if (d <= date) {
          d.setFullYear(d.getFullYear() + 1);
        }
        return d;
      });
      vestDates.sort((a, b) => a - b);
      return vestDates[0];
    }

    function getVestDatesInRange(startDate, endDate) {
      const dates = [];
      let current = new Date(startDate.getFullYear(), VEST_MONTHS[0], 1);

      // Start from beginning of the year of startDate
      while (current <= endDate) {
        for (const month of VEST_MONTHS) {
          const vestDate = new Date(current.getFullYear(), month, 1);
          if (vestDate >= startDate && vestDate <= endDate) {
            dates.push(new Date(vestDate));
          }
        }
        current.setFullYear(current.getFullYear() + 1);
      }

      return dates.sort((a, b) => a - b);
    }

    function calculateInitialGrantVesting(joinDate, totalShares, startDate, endDate) {
      const vesting = [];

      // 1st anniversary = join date + 1 year
      const firstAnniversary = new Date(joinDate);
      firstAnniversary.setFullYear(firstAnniversary.getFullYear() + 1);

      // Cliff vest = first vest date on or after 1st anniversary
      const cliffDate = getFirstVestDateOnOrAfter(firstAnniversary);

      // Vesting ends 4 years after join (16 quarters total)
      const vestingEndDate = new Date(joinDate);
      vestingEndDate.setFullYear(vestingEndDate.getFullYear() + 5); // 4 years of vesting after cliff

      // Get all vest dates from cliff to end
      const vestDates = getVestDatesInRange(cliffDate, vestingEndDate);

      // At cliff: 25% vests
      // Remaining 75% vests over next 12 quarters (6.25% each)
      const cliffShares = totalShares * 0.25;
      const quarterlyShares = (totalShares * 0.75) / 12;

      vestDates.forEach((vestDate, index) => {
        if (vestDate >= startDate && vestDate <= endDate) {
          // Only count up to 13 vests (1 cliff + 12 quarterly)
          if (index < 13) {
            const shares = index === 0 ? cliffShares : quarterlyShares;
            vesting.push({
              date: vestDate,
              shares: shares,
              type: 'initial',
              note: index === 0 ? 'Cliff vest' : 'Quarterly vest'
            });
          }
        }
      });

      return vesting;
    }

    function calculateRefresherVesting(grantDate, totalShares, startDate, endDate) {
      const vesting = [];

      // Refreshers vest quarterly over 4 years
      // First vest is on the quarter AFTER the grant (strictly after grant date)
      const firstVestDate = getFirstVestDateStrictlyAfter(grantDate);
      const vestingEndDate = new Date(grantDate);
      vestingEndDate.setFullYear(vestingEndDate.getFullYear() + 5); // Give buffer for 16 quarters

      const vestDates = getVestDatesInRange(firstVestDate, vestingEndDate);
      const sharesPerQuarter = totalShares / 16; // 4 years * 4 quarters = 6.25% each

      let vestCount = 0;
      vestDates.forEach(vestDate => {
        if (vestDate >= startDate && vestDate <= endDate && vestCount < 16) {
          vesting.push({
            date: vestDate,
            shares: sharesPerQuarter,
            type: 'refresher',
            grantYear: grantDate.getFullYear()
          });
          vestCount++;
        }
      });

      return vesting;
    }

    function calculate() {
      const joinDateStr = document.getElementById('joinDate').value;
      const baseSalary = parseFloat(document.getElementById('baseSalary').value);
      const bonusPercent = parseFloat(document.getElementById('bonusPercent').value) || 0;
      const stockPrice = parseFloat(document.getElementById('stockPrice').value);
      const initialGrant = parseInt(document.getElementById('initialGrant').value) || 0;
      const reductionPercent = parseFloat(document.getElementById('reductionPercent').value) || 0;

      if (!joinDateStr || !baseSalary || !stockPrice) {
        alert('Please fill in all required fields');
        return;
      }

      const joinDate = new Date(joinDateStr);
      const today = new Date();
      const startYear = joinDate.getFullYear();
      const endDate = new Date(today);
      endDate.setFullYear(endDate.getFullYear() + 4);
      const endYear = endDate.getFullYear();

      // Calculate the cliff date (first vest of initial grant)
      // This is when the first refresher is granted
      const firstAnniversary = new Date(joinDate);
      firstAnniversary.setFullYear(firstAnniversary.getFullYear() + 1);
      const cliffDate = getFirstVestDateOnOrAfter(firstAnniversary);

      // Collect past refresher grants
      const refresherInputs = document.querySelectorAll('#refreshersGrid input');
      const refreshers = [];
      let pastTotal = 0;
      let pastCount = 0;

      refresherInputs.forEach(input => {
        const year = parseInt(input.dataset.year); // Year 2, 3, 4, etc.
        const shares = parseInt(input.value) || 0;

        if (shares > 0) {
          pastTotal += shares;
          pastCount++;
          // Refreshers are granted on the cliff date anniversary
          // Year 2 = cliff date, Year 3 = cliff date + 1 year, etc.
          const grantDate = new Date(cliffDate);
          grantDate.setFullYear(cliffDate.getFullYear() + (year - 2));
          refreshers.push({ grantDate, shares, year, isFuture: false });
        }
      });

      // Calculate future refreshers based on average of past refreshers
      const avgPastRefresher = pastCount > 0 ? pastTotal / pastCount : 0;
      const futureRefresherShares = Math.round(avgPastRefresher * reductionPercent / 100);

      // Determine the first future refresher year (current year or later)
      const currentYear = today.getFullYear();
      const cliffYear = cliffDate.getFullYear();
      // Year 2 corresponds to cliff date, Year N = cliffYear + (N - 2)
      let firstFutureYear = Math.max(2, currentYear - cliffYear + 2);

      // Add future refreshers (from current year through 4 years from now)
      if (futureRefresherShares > 0) {
        let futureYear = firstFutureYear;
        let grantDate = new Date(cliffDate);
        grantDate.setFullYear(cliffYear + (futureYear - 2));

        while (grantDate <= endDate) {
          refreshers.push({
            grantDate: new Date(grantDate),
            shares: futureRefresherShares,
            year: futureYear,
            isFuture: true
          });
          futureYear++;
          grantDate.setFullYear(grantDate.getFullYear() + 1);
        }
      }

      // Calculate yearly breakdown
      const yearlyData = [];

      for (let year = startYear; year <= endYear; year++) {
        const yearStart = new Date(year, 0, 1);
        const yearEnd = new Date(year, 11, 31);

        // Determine what portion of the year to count
        const effectiveStart = year === startYear ? joinDate : yearStart;
        const effectiveEnd = year === endYear ? endDate : yearEnd;

        // Calculate days worked this year
        const daysInYear = (yearEnd - yearStart) / (1000 * 60 * 60 * 24) + 1;
        const daysWorked = Math.max(0, (effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24) + 1);
        const yearFraction = Math.min(1, daysWorked / daysInYear);

        // Base salary (prorated for partial years)
        const yearBaseSalary = baseSalary * yearFraction;

        // Bonus (prorated)
        const yearBonus = yearBaseSalary * (bonusPercent / 100);

        // Initial grant vesting (with historical prices)
        const initialVesting = calculateInitialGrantVesting(joinDate, initialGrant, effectiveStart, effectiveEnd);
        const initialShares = initialVesting.reduce((sum, v) => sum + v.shares, 0);
        const initialValue = initialVesting.reduce((sum, v) => {
          const price = getStockPriceForDate(v.date, stockPrice);
          return sum + (v.shares * price);
        }, 0);

        // Refresher vesting (with historical prices)
        let refresherShares = 0;
        let refresherValue = 0;
        refreshers.forEach(r => {
          const vesting = calculateRefresherVesting(r.grantDate, r.shares, effectiveStart, effectiveEnd);
          refresherShares += vesting.reduce((sum, v) => sum + v.shares, 0);
          refresherValue += vesting.reduce((sum, v) => {
            const price = getStockPriceForDate(v.date, stockPrice);
            return sum + (v.shares * price);
          }, 0);
        });

        // Refresher grants received this year (not vested, but granted)
        let refresherReceived = 0;
        refreshers.forEach(r => {
          if (r.grantDate.getFullYear() === year) {
            refresherReceived += r.shares;
          }
        });

        const totalSharesVested = initialShares + refresherShares;
        const rsuValue = initialValue + refresherValue;
        const totalComp = yearBaseSalary + yearBonus + rsuValue;

        yearlyData.push({
          year,
          baseSalary: yearBaseSalary,
          bonus: yearBonus,
          initialShares,
          initialValue,
          refresherShares,
          refresherValue,
          refresherReceived,
          totalSharesVested,
          rsuValue,
          totalComp,
          isPartial: yearFraction < 1
        });
      }

      // Calculate cumulative totals and unvested RSU
      let cumulativeInitialVested = 0;
      let cumulativeRefresherVested = 0;
      let cumulativeRefresherGranted = 0;

      for (let i = 0; i < yearlyData.length; i++) {
        cumulativeInitialVested += yearlyData[i].initialShares;
        cumulativeRefresherVested += yearlyData[i].refresherShares;
        cumulativeRefresherGranted += yearlyData[i].refresherReceived;

        // Unvested = (initial grant - cumulative initial vested) + (cumulative refresher granted - cumulative refresher vested)
        const unvestedInitial = Math.max(0, initialGrant - cumulativeInitialVested);
        const unvestedRefresher = Math.max(0, cumulativeRefresherGranted - cumulativeRefresherVested);
        yearlyData[i].unvestedShares = unvestedInitial + unvestedRefresher;

        // Year-over-year changes
        if (i === 0) {
          yearlyData[i].changeAbsolute = null;
          yearlyData[i].changePercent = null;
        } else {
          const prevComp = yearlyData[i - 1].totalComp;
          const currComp = yearlyData[i].totalComp;
          yearlyData[i].changeAbsolute = currComp - prevComp;
          yearlyData[i].changePercent = prevComp > 0 ? ((currComp - prevComp) / prevComp) * 100 : null;
        }
      }

      // Collect all grant and vest events for the detailed table
      const events = [];

      // Add initial grant vest events
      const initialVestEvents = calculateInitialGrantVesting(joinDate, initialGrant, joinDate, endDate);
      initialVestEvents.forEach(v => {
        events.push({
          date: v.date,
          granted: 0,
          vested: v.shares,
          type: 'initial',
          note: v.note
        });
      });

      // Add refresher grant and vest events
      refreshers.forEach(r => {
        // Grant event
        events.push({
          date: r.grantDate,
          granted: r.shares,
          vested: 0,
          type: 'refresher-grant',
          note: `Year ${r.year} refresher${r.isFuture ? ' (projected)' : ''}`
        });

        // Vest events for this refresher
        const vestEvents = calculateRefresherVesting(r.grantDate, r.shares, joinDate, endDate);
        vestEvents.forEach(v => {
          events.push({
            date: v.date,
            granted: 0,
            vested: v.shares,
            type: 'refresher-vest',
            note: `Year ${r.year} refresher vest`
          });
        });
      });

      // Sort events by date
      events.sort((a, b) => a.date - b.date);

      // Merge events on the same date
      const mergedEvents = [];
      events.forEach(e => {
        const dateStr = e.date.toISOString().split('T')[0];
        const existing = mergedEvents.find(m => m.date.toISOString().split('T')[0] === dateStr);
        if (existing) {
          existing.granted += e.granted;
          existing.vested += e.vested;
          if (e.note && !existing.note.includes(e.note)) {
            existing.note += ', ' + e.note;
          }
        } else {
          mergedEvents.push({ ...e });
        }
      });

      // Store data globally for toggle
      calculatedData = {
        yearlyData,
        initialGrant,
        pastCount,
        avgPastRefresher,
        futureRefresherShares,
        reductionPercent,
        events: mergedEvents
      };
      currentStockPrice = stockPrice;

      renderResultsTable();
      document.getElementById('results').style.display = 'block';
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    function toggleRsuDisplay() {
      if (calculatedData) {
        renderResultsTable();
      }
    }

    function renderResultsTable() {
      const { yearlyData, initialGrant, pastCount, avgPastRefresher, futureRefresherShares, reductionPercent } = calculatedData;
      const showJpy = document.getElementById('showJpy').checked;
      const stockPrice = currentStockPrice;

      // Helper to format RSU values based on toggle
      const formatRsu = (shares) => {
        if (shares === 0) return '-';
        if (showJpy) {
          return formatMoney(shares * stockPrice);
        }
        return formatShares(shares);
      };

      let html = `
        <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>Base Salary</th>
              <th>Bonus</th>
              <th>Refreshers Granted</th>
              <th>Initial Vested</th>
              <th>Refreshers Vested</th>
              <th>Total RSU Vested</th>
              <th>Unvested RSU</th>
              <th>Total Comp</th>
              <th>YoY Change</th>
              <th>YoY %</th>
            </tr>
          </thead>
          <tbody>
      `;

      let grandTotal = 0;
      let totalBaseSalary = 0;
      let totalBonus = 0;
      let totalInitialShares = 0;
      let totalInitialValue = 0;
      let totalRefresherShares = 0;
      let totalRefresherValue = 0;
      let totalRefresherGranted = 0;
      let totalRsuShares = 0;
      let totalRsuValue = 0;

      // Helper to format RSU with historical value support
      const formatRsuWithValue = (shares, value) => {
        if (shares === 0) return '-';
        if (showJpy) {
          return formatMoney(value);
        }
        return formatShares(shares);
      };

      yearlyData.forEach(data => {
        grandTotal += data.totalComp;
        totalBaseSalary += data.baseSalary;
        totalBonus += data.bonus;
        totalInitialShares += data.initialShares;
        totalInitialValue += data.initialValue;
        totalRefresherShares += data.refresherShares;
        totalRefresherValue += data.refresherValue;
        totalRefresherGranted += data.refresherReceived;
        totalRsuShares += data.totalSharesVested;
        totalRsuValue += data.rsuValue;

        const changeClass = data.changeAbsolute === null ? '' :
          (data.changeAbsolute >= 0 ? 'change-positive' : 'change-negative');
        const changeAbsoluteStr = data.changeAbsolute === null ? '-' :
          (data.changeAbsolute >= 0 ? '+' : '') + formatMoney(data.changeAbsolute);
        const changePercentStr = data.changePercent === null ? '-' :
          (data.changePercent >= 0 ? '+' : '') + data.changePercent.toFixed(1) + '%';

        // For unvested, use current stock price since they haven't vested yet
        const unvestedValue = data.unvestedShares * stockPrice;

        html += `
          <tr>
            <td>${data.year}${data.isPartial ? '*' : ''}</td>
            <td class="money">${formatMoney(data.baseSalary)}</td>
            <td class="money">${formatMoney(data.bonus)}</td>
            <td class="money">${formatRsu(data.refresherReceived)}</td>
            <td class="money">${formatRsuWithValue(data.initialShares, data.initialValue)}</td>
            <td class="money">${formatRsuWithValue(data.refresherShares, data.refresherValue)}</td>
            <td class="money">${formatRsuWithValue(data.totalSharesVested, data.rsuValue)}</td>
            <td class="money">${formatRsuWithValue(data.unvestedShares, unvestedValue)}</td>
            <td class="money">${formatMoney(data.totalComp)}</td>
            <td class="money ${changeClass}">${changeAbsoluteStr}</td>
            <td class="money ${changeClass}">${changePercentStr}</td>
          </tr>
        `;
      });

      // For total unvested, use current stock price
      const lastYearData = yearlyData[yearlyData.length - 1];
      const totalUnvestedValue = lastYearData ? lastYearData.unvestedShares * stockPrice : 0;

      html += `
          <tr class="total-row">
            <td>TOTAL</td>
            <td class="money">${formatMoney(totalBaseSalary)}</td>
            <td class="money">${formatMoney(totalBonus)}</td>
            <td class="money">${formatRsu(totalRefresherGranted)}</td>
            <td class="money">${formatRsuWithValue(totalInitialShares, totalInitialValue)}</td>
            <td class="money">${formatRsuWithValue(totalRefresherShares, totalRefresherValue)}</td>
            <td class="money">${formatRsuWithValue(totalRsuShares, totalRsuValue)}</td>
            <td></td>
            <td class="money">${formatMoney(grandTotal)}</td>
            <td colspan="2"></td>
          </tr>
        </tbody>
      </table>
      </div>
      <p class="hint">* Partial year (prorated based on join date or calculation end date). RSU values use historical stock prices for past vest dates.</p>
      `;

      if (pastCount > 0) {
        const avgDisplay = Math.round(avgPastRefresher).toLocaleString();
        const futureDisplay = futureRefresherShares.toLocaleString();
        html += `<p style="margin-top: 16px; padding: 12px; background: #e8f4fc; border-radius: 4px;">
          <strong>Refresher calculation:</strong><br>
          Average past refresher: ${avgDisplay} shares<br>
          Future refresher (${reductionPercent}% of average): ${futureDisplay} shares/year
        </p>`;
      }

      // Events table (grant and vest schedule)
      const { events } = calculatedData;
      if (events && events.length > 0) {
        html += `
          <h3 style="margin-top: 24px; margin-bottom: 12px;">RSU Grant & Vest Schedule</h3>
          <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Stock Price</th>
                <th>RSU Granted</th>
                <th>RSU Vested</th>
                <th>Vested Value</th>
              </tr>
            </thead>
            <tbody>
        `;

        let totalGranted = 0;
        let totalVested = 0;
        let totalVestedValue = 0;

        events.forEach(event => {
          totalGranted += event.granted;
          totalVested += event.vested;

          const dateStr = event.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          const historicalPrice = getStockPriceForDate(event.date, stockPrice);
          const vestedValue = event.vested * historicalPrice;
          totalVestedValue += vestedValue;

          const priceNote = HISTORICAL_STOCK_PRICES[`${event.date.getFullYear()}-${String(event.date.getMonth() + 1).padStart(2, '0')}-01`] ? '' : '*';

          html += `
            <tr>
              <td>${dateStr}</td>
              <td class="money">${formatMoney(historicalPrice)}${priceNote}</td>
              <td class="money">${event.granted > 0 ? formatShares(event.granted) : '-'}</td>
              <td class="money">${event.vested > 0 ? formatShares(event.vested) : '-'}</td>
              <td class="money">${event.vested > 0 ? formatMoney(vestedValue) : '-'}</td>
            </tr>
          `;
        });

        html += `
            <tr class="total-row">
              <td>TOTAL</td>
              <td></td>
              <td class="money">${formatShares(totalGranted)}</td>
              <td class="money">${formatShares(totalVested)}</td>
              <td class="money">${formatMoney(totalVestedValue)}</td>
            </tr>
          </tbody>
        </table>
        </div>
        <p class="hint">* Stock price from user input (no historical data available for this date)</p>
        `;
      }

      document.getElementById('resultsContent').innerHTML = html;
    }

    function formatMoney(amount) {
      return '¥' + Math.round(amount).toLocaleString();
    }

    function formatShares(shares) {
      return Math.round(shares).toLocaleString() + ' sh';
    }
  </script>
</body>
</html>
